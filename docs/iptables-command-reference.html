<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <title>iptables 常用命令参考</title>
    <style>
      :root {
        --bg: #f7f9fc;
        --card: #ffffff;
        --primary: #1e9fff;
        --text: #2b2b2b;
        --muted: #5f6673;
        --border: #e3e7ef;
        --code-bg: #0f172a;
        --code-text: #e2e8f0;
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
        margin: 0;
        padding: 30px 0;
        background: var(--bg);
        color: var(--text);
        line-height: 1.7;
      }
      .container {
        max-width: 900px;
        margin: auto;
        padding: 0 20px 40px;
      }
      h1,
      h2,
      h3 {
        color: var(--primary);
        margin-top: 32px;
      }
      h1 {
        margin-top: 0;
        font-size: 2.2rem;
      }
      h2 {
        font-size: 1.6rem;
      }
      h3 {
        font-size: 1.2rem;
      }
      p,
      li {
        color: var(--muted);
      }
      ul {
        padding-left: 20px;
      }
      code {
        font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
        background: rgba(30, 159, 255, 0.08);
        padding: 0 4px;
        border-radius: 4px;
        color: var(--primary);
      }
      pre {
        background: var(--code-bg);
        color: var(--code-text);
        padding: 16px;
        border-radius: 10px;
        overflow: auto;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.35);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin: 16px 0;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 10px;
      }
      th,
      td {
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
        text-align: left;
      }
      th {
        background: rgba(30, 159, 255, 0.08);
        color: var(--primary);
      }
      tr:last-child td {
        border-bottom: none;
      }
      .card {
        background: var(--card);
        padding: 24px;
        border-radius: 16px;
        margin-bottom: 24px;
        box-shadow: 0 20px 40px rgba(15, 23, 42, 0.12);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <h1>iptables 常用命令参考</h1>
        <p>
          本文整理了在 Linux 环境下使用
          <code>iptables</code>/<code>ip6tables</code>
          的常见命令、参数说明以及典型使用场景，便于初学者查询与实践。
        </p>
        <h2>1. 基础概念</h2>
        <ul>
          <li>
            <strong>表（Table）</strong
            >：按功能划分。常见的 <code>raw</code>（连接跟踪前）、<code
              >mangle</code
            >（数据包修改）、<code>nat</code>（地址转换）、<code
              >filter</code
            >（包过滤）。
          </li>
          <li>
            <strong>链（Chain）</strong
            >：数据包在每张表中的处理路径，例如 <code>INPUT</code>、<code
              >OUTPUT</code
            >、<code>FORWARD</code>、<code>PREROUTING</code>、<code
              >POSTROUTING</code
            >。自定义链可由用户创建。
          </li>
          <li>
            <strong>规则（Rule）</strong
            >：由匹配条件与目标动作组成，匹配顺序从上到下执行。
          </li>
          <li>
            <strong>目标（Target）</strong
            >：动作，例如 <code>ACCEPT</code>、<code>DROP</code>、<code
              >REJECT</code
            >、<code>LOG</code>、<code>SNAT</code>、<code>DNAT</code> 等。
          </li>
        </ul>
        <p>
          IPv6 使用 <code>ip6tables</code> 命令，语法与 IPv4
          基本一致，仅在地址/模块支持上存在差异。
        </p>
        <h2>2. 命令结构</h2>
        <pre><code>iptables [-t 表] COMMAND [链] [匹配条件] [-j 目标]</code></pre>
        <p>常用全局选项：</p>
        <table>
          <thead>
            <tr>
              <th>参数</th>
              <th>说明</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>-t</code></td>
              <td>指定表，默认 <code>filter</code>。</td>
            </tr>
            <tr>
              <td><code>-L</code></td>
              <td>列出链规则，配合 <code>-n</code>、<code>-v</code>、<code
                  >--line-numbers</code
                >。
              </td>
            </tr>
            <tr>
              <td><code>-A</code> / <code>-I</code> / <code>-D</code> / <code>-R</code></td>
              <td>追加、插入、删除、替换。</td>
            </tr>
            <tr>
              <td><code>-F</code> / <code>-Z</code> / <code>-X</code></td>
              <td>清空规则、清零计数、删除自定义链。</td>
            </tr>
            <tr>
              <td><code>-P</code></td>
              <td>设置链的默认策略（仅系统链）。</td>
            </tr>
            <tr>
              <td><code>-j</code></td>
              <td>指定目标动作。</td>
            </tr>
            <tr>
              <td><code>-m</code></td>
              <td>启用匹配模块，例如 <code>state</code>/<code>conntrack</code>/<code
                  >limit</code
                > 等。
              </td>
            </tr>
          </tbody>
        </table>
        <h2>3. 常用命令速查</h2>
        <h3>3.1 查看现有规则</h3>
        <pre><code>iptables -L -n -v --line-numbers
iptables -t nat -L -n -v
ip6tables -t filter -L INPUT -n</code></pre>
        <h3>3.2 设置默认策略</h3>
        <pre><code>iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT</code></pre>
        <h3>3.3 允许 SSH / Web 等端口</h3>
        <pre><code>iptables -A INPUT -p tcp --dport 22 -s 10.0.0.0/24 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT
iptables -A INPUT -p tcp --dport 80 -m state --state NEW -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -m state --state NEW -j ACCEPT</code></pre>
        <h3>3.4 拒绝或限制流量</h3>
        <pre><code>iptables -A INPUT -p tcp --dport 25 -j REJECT --reject-with icmp-port-unreachable
iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m recent --set --name SSH
iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m recent --update --seconds 60 --hitcount 5 --name SSH -j DROP</code></pre>
        <h3>3.5 NAT / 端口转发</h3>
        <pre><code># 内网访问 Internet，使用 SNAT
iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -o eth0 -j SNAT --to-source 203.0.113.10
# 动态地址环境（例如 PPPoE）可使用 MASQUERADE
iptables -t nat -A POSTROUTING -s 10.10.0.0/16 -o ppp0 -j MASQUERADE

# DNAT：将外网流量转发至内网主机
iptables -t nat -A PREROUTING -d 203.0.113.10/32 -p tcp --dport 2222 -j DNAT --to-destination 192.168.0.10:22
iptables -A FORWARD -p tcp -d 192.168.0.10 --dport 22 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT
iptables -A FORWARD -p tcp -s 192.168.0.10 --sport 22 -m state --state ESTABLISHED -j ACCEPT</code></pre>
        <h3>3.6 透明代理 / 端口劫持</h3>
        <pre><code># 将 80 端口流量转交给本机 8080（如 HTTP 代理）
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j REDIRECT --to-ports 8080</code></pre>
        <h3>3.7 记录与速率限制</h3>
        <pre><code>iptables -A INPUT -p tcp --dport 22 -m limit --limit 3/min -j LOG --log-prefix "SSH attempt: "
iptables -A INPUT -p icmp -m limit --limit 1/s --limit-burst 5 -j ACCEPT
iptables -A INPUT -p icmp -j DROP</code></pre>
        <h3>3.8 保存与恢复</h3>
        <pre><code>iptables-save > /etc/iptables/rules.v4
ip6tables-save > /etc/iptables/rules.v6
iptables-restore < /etc/iptables/rules.v4
ip6tables-restore < /etc/iptables/rules.v6</code></pre>
        <h2>4. 场景示例</h2>
        <h3>场景 A：只允许特定网段访问 SSH</h3>
        <pre><code>iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT
iptables -A INPUT -i lo -j ACCEPT
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT -p tcp --dport 22 -s 192.168.1.0/24 -m state --state NEW -j ACCEPT
iptables -A INPUT -j LOG --log-prefix "DROP INPUT: "</code></pre>
        <h3>场景 B：双网卡网关的 SNAT 与防火墙</h3>
        <pre><code># 开启内核转发
sysctl -w net.ipv4.ip_forward=1

# NAT 公网出口
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# 转发策略
iptables -A FORWARD -i eth1 -o eth0 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT
iptables -A FORWARD -i eth0 -o eth1 -m state --state ESTABLISHED,RELATED -j ACCEPT

# 阻断外网主动访问内网
iptables -A FORWARD -i eth0 -o eth1 -j DROP</code></pre>
        <h3>场景 C：IPv6 入站仅开放 80/443</h3>
        <pre><code>ip6tables -P INPUT DROP
ip6tables -P FORWARD DROP
ip6tables -P OUTPUT ACCEPT
ip6tables -A INPUT -i lo -j ACCEPT
ip6tables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
ip6tables -A INPUT -p tcp --dport 80 -j ACCEPT
ip6tables -A INPUT -p tcp --dport 443 -j ACCEPT</code></pre>
        <h3>场景 D：限制单 IP 并发连接数</h3>
        <pre><code>iptables -A INPUT -p tcp --syn --dport 80 -m connlimit --connlimit-above 50 --connlimit-mask 32 -j REJECT</code></pre>
        <h2>5. 故障排查建议</h2>
        <ol>
          <li>
            <strong>规则与 nftables 冲突</strong
            >：确认是否启用了 <code>iptables-nft</code>，必要时安装
            <code>iptables-legacy</code>。
          </li>
          <li>
            <strong>模块不可用</strong
            >：例如 <code>-m conntrack</code> 报错，需加载
            <code>nf_conntrack</code> 模块或安装对应包。
          </li>
          <li>
            <strong>顺序问题</strong
            >：规则按顺序匹配，使用 <code>--line-numbers</code> 查看并用
            <code>-I</code>/<code>-R</code> 调整。
          </li>
          <li>
            <strong>调试</strong
            >：利用 <code>LOG</code> 目标输出到 <code>dmesg</code>/<code
              >/var/log/messages</code
            >。
          </li>
          <li>
            <strong>持久化</strong
            >：使用 <code>iptables-save</code> 配合
            <code>systemd</code>/<code>/etc/rc.local</code> 或发行版工具。
          </li>
        </ol>
        <h2>6. 进阶阅读</h2>
        <ul>
          <li><code>man iptables</code> / <code>man ip6tables</code></li>
          <li><code>man iptables-extensions</code></li>
          <li>Netfilter.org 官方文档</li>
        </ul>
        <p>
          结合 iptables-web，可以在图形界面中执行上述命令、观察效果并快速导出/导入规则，降低学习成本。
        </p>
      </div>
    </div>
  </body>
</html>
